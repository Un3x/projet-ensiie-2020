<!DOCTYPE HTML>
<?php

include '../src/User.php';
include '../src/UserRepository.php';
include '../src/Aliment.php';
include '../src/AlimentRepository.php';
include '../src/Commande.php';
include '../src/CommandeRepository.php';
include '../src/Factory/DbAdaperFactory.php';

$dbAdaper = (new DbAdaperFactory())->createService();
$userRepository = new \User\UserRepository($dbAdaper);
$users = $userRepository->fetchAll();
$alimentRepository = new \Aliment\AlimentRepository($dbAdaper);
$aliments = $alimentRepository->fetchall();
$commandeRepository = new \Commande\CommandeRepository($dbAdaper);
$commandes = $commandeRepository->fetchall();
session_start();
$commande = $commandeRepository->fetchCommande($_POST['commande_id']);
$user_id = $commandeRepository->associatedClient($commande->getId());
?>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>EpicEvry</title>

    <meta name="description" content="Projet web Ensiie">
    <meta name="author" content="Us">
    <?php include "./css_head.html" ?>
</head>


	<style>
		h1 {color: #26272B; text-align : center;}
		th {color : #BECFBD; text-align: center;}
		td {color : #FFFFFF; text-align: center; }
		p {color : #FFFFFF;
		#author {font-weight : bold; color : #FFFACD;}
		#bouton {color : #FFFFFF; background-color : #26272B; font-weight : bold; border : none;}


	</style> 

<body style="background-color: #677179">

<?php include "./header.html" ?>
<?php if (!isset($_SESSION['id']) OR (($_SESSION['role'] != 1) AND ($user_id != $_SESSION['username']))) {
$erreur="notConnected";
      header("Location: page_connexion.php?erreur={$erreur}");
      }
?>

<?php if (empty($commande)):
$erreur="commandeUnknown";
header("Location: page_gestion_admin.php?erreur={$erreur}");
endif ?>
<div class="container">
    <div class="row">
        <div class="col-sm-12">
	<div class="title-table">
	    <h1>Commande n°: <?= $_POST['commande_id']?></h1>
        </div>
	<table class="table">
	<tr>
		    <th>date_livraison</th>
                    <th>prix total</th>
		    <th>Client</th>
        </tr>
	<tr>
                        <td><?= $commande->getDateLivraison() ?></td>
			<td><?= $commande->getPrixTotal() ?></td>
			<td><?= $commandeRepository->associatedClient($commande->getId()) ?></td>
        </tr>
	</table>
	</div>

	<div class="col-sm-12">
	<div class="title-table">
	    <h1>Aliments commandés</h1>
	    <?php $aliments = $commandeRepository->getDetailsCommande($_POST['commande_id']); ?>
        </div>
	<table class="table">
	<tr>
		    <th>Aliment</th>
                    <th>Quantité</th>
		    <th>Sous total</th>
        </tr>
	<?php foreach($aliments as $alimentInfos): ?>
	<?php $aliment = $alimentRepository->fetchAliment($alimentInfos[0]) ?>
	<tr>
		<td><?= $aliment->getNom_aliment() ?></td>
		<td><?= $alimentInfos[1] ?> kg </td>
		<td><?= $aliment->getPrix_aliment() * $alimentInfos[1] ?> € </td>
	</tr>
	<?php endforeach; ?>
	</table>
	</div>
                            <form method="POST" action="/deleteCommande.php">
                                <input name="commande_id" type="hidden" value="<?=  $_POST['commande_id']?>">
                               <button type="submit" id="bouton">Supprimer</button>
                            </form>
    </div>
</div>
<script src="js/scripts.js"></script>
<?php include "./footer.html" ?>
</body>
</html>
