<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>Bibliothèque OAuth pour Arise</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 7614 2013-02-21 15:55:51Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

object[type="image/svg+xml"], object[type="application/x-shockwave-flash"] {
  overflow: hidden;
}

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left, object.align-left {
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right, object.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

img.align-center, .figure.align-center, object.align-center {
  display: block;
  margin-left: auto;
  margin-right: auto;
}

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: inherit }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block, pre.math, pre.code {
  margin-left: 2em ;
  margin-right: 2em }

pre.code .ln { color: grey; } /* line numbers */
pre.code, code { background-color: #eeeeee }
pre.code .comment, code .comment { color: #5C6576 }
pre.code .keyword, code .keyword { color: #3B0D06; font-weight: bold }
pre.code .literal.string, code .literal.string { color: #0C5404 }
pre.code .name.builtin, code .name.builtin { color: #352B84 }
pre.code .deleted, code .deleted { background-color: #DEB0A1}
pre.code .inserted, code .inserted { background-color: #A3D289}

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

/* "booktabs" style (no vertical lines) */
table.docutils.booktabs {
  border: 0px;
  border-top: 2px solid;
  border-bottom: 2px solid;
  border-collapse: collapse;
}
table.docutils.booktabs * {
  border: 0px;
}
table.docutils.booktabs th {
  border-bottom: thin solid;
  text-align: left;
}

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="bibliotheque-oauth-pour-arise">
<h1 class="title">Bibliothèque OAuth pour Arise</h1>

<p>OAuth est un mécanisme permettant à des applications (dans le navigateur et en dehors) d'accéder à des données des élèves, stockées chez Arise, tout en garantissant à celui-ci que ses identifiants ne soient pas communiqués et en s'assurant que les applications n'aient accès qu'aux informations qu'il désire transmettre.</p>
<blockquote>
<ul class="simple">
<li>Pour plus d'informations sur OAuth, vous pouvez lire le chapitre <a class="reference internal" href="#oauth-pour-les-nuls">OAuth pour les nuls</a>.</li>
<li>Pour développer une application, commencez par <a class="reference internal" href="#preparation">Préparation</a>.</li>
<li>Si des questions et des doutes persistent, <tt class="docutils literal">#arise</tt> est votre ami.</li>
</ul>
</blockquote>
<div class="section" id="preparation">
<h1>Préparation</h1>
<p>Avant d'utiliser la bibliothèque OAuth pour Arise, il faut :</p>
<blockquote>
<ul class="simple">
<li>se connecter sur <a class="reference external" href="http://oauth.iiens.net">http://oauth.iiens.net</a>,</li>
<li>aller dans la partie <em>Mes applications</em> et en créer une nouvelle,</li>
<li>entrer un nom,</li>
<li>choisir le type d'application :<ul>
<li>application dans le navigateur pour un site Web (le cas le plus courant),</li>
<li>application de bureau pour une application s'exécutant indépendamment (application Android par exemple),</li>
</ul>
</li>
<li>entrer une URL de déconnexion pour le mécanisme de Single LogOut,<ul>
<li>cette information est facultative. Cependant, pour une meilleure sécurité il est recommandé de la spécifier : il s'agit d'une URL qui sera appelée par AriseID lorsque l'utilisateur ferme sa session AriseID</li>
</ul>
</li>
<li>choisir les différentes autorisations nécessaires au fonctionnement de l'appli.</li>
</ul>
</blockquote>
<p>Une fois toutes ces informations renseignées, AriseID vour fournira trois informations :</p>
<blockquote>
<ul class="simple">
<li>un identifiant et un secret vous servant à authentifier votre application auprès d'AriseID,</li>
<li>une clé privée utilisée pour garantir la confidentialité des informations stockées par la bibliothèque chez AriseID</li>
</ul>
</blockquote>
<p>La clé privée n'est utilisée que par la bibliothèque Arise alors que l'identifiant et le secret sont utilisés par toutes les bibliothèques OAuth.</p>
</div>
<div class="section" id="developpement-d-une-application-oauth-avec-la-bibliotheque-arise">
<h1>Développement d'une application OAuth avec la bibliothèque Arise</h1>
<p>Méthode par l'exemple:</p>
<pre class="code php literal-block">
<span class="comment preproc">&lt;?php</span>

<span class="comment multiline">/* On inclut la bibliothèque Arise pour OAuth. */</span>
<span class="comment multiline">/* ======================= ATTENTION ! ======================== */</span>
<span class="comment multiline">/* Ce fichier doit être inclut AVANT un appel à session_start() */</span>
<span class="keyword">require_once</span><span class="punctuation">(</span><span class="literal string double">&quot;/usr/share/php/ariseid/client/OAuthAriseClient.php&quot;</span><span class="punctuation">);</span>

<span class="comment multiline">/*
   Le fichier config.inc.php contient les informations d'identifications.
   Elles sont à garder précieusement : attention aux droits du fichier !
*/</span>
<span class="comment multiline">/*
  config.inc.php contient les variables suivantes :
        $consumer_key = 'bc323b713288ac871a33e372c9b1bd92';
        $consumer_secret = 'c36df8385b6f333ce0b4dae055edd5d5';
        $consumer_private_key = '71f3cf528bc87ba88d0af1b3ed2db1ad';
*/</span>
<span class="keyword">require_once</span><span class="punctuation">(</span><span class="literal string double">&quot;./config.inc.php&quot;</span><span class="punctuation">);</span>

<span class="comment multiline">/*
   On crée l'objet Consumer qui va vous permettre d'interagir avec Arise :
   on lui fournit les trois informations données lors de la création de
   l'application dans le chapitre précédent.
*/</span>
<span class="name variable">$consumer</span> <span class="operator">=</span> <span class="name other">OAuthAriseClient</span><span class="operator">::</span><span class="name attribute">getInstance</span><span class="punctuation">(</span><span class="name variable">$consumer_key</span><span class="punctuation">,</span> <span class="name variable">$consumer_secret</span><span class="punctuation">,</span>
        <span class="name variable">$consumer_private_key</span><span class="punctuation">);</span>

<span class="keyword">if</span> <span class="punctuation">(</span><span class="name builtin">isset</span><span class="punctuation">(</span><span class="name variable">$_POST</span><span class="punctuation">[</span><span class="literal string single">'login'</span><span class="punctuation">]))</span> <span class="punctuation">{</span>
        <span class="comment multiline">/*
           L'utilisateur a cliqué sur le bouton de connexion.
           Nous allons donc l'authentifier.
        */</span>
        <span class="name variable">$consumer</span><span class="operator">-&gt;</span><span class="name attribute">authenticate</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="keyword">if</span> <span class="punctuation">(</span><span class="name builtin">isset</span><span class="punctuation">(</span><span class="name variable">$_POST</span><span class="punctuation">[</span><span class="literal string single">'logout'</span><span class="punctuation">]))</span> <span class="punctuation">{</span>
        <span class="comment multiline">/*
           L'utilisateur a cliqué sur le bouton de déconnexion.
           Nous allons donc effacer ses informations d'authentification.
        */</span>
        <span class="name variable">$consumer</span><span class="operator">-&gt;</span><span class="name attribute">logout</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="keyword">if</span> <span class="punctuation">(</span><span class="name variable">$consumer</span><span class="operator">-&gt;</span><span class="name attribute">has_just_authenticated</span><span class="punctuation">())</span> <span class="punctuation">{</span>
        <span class="comment multiline">/*
           Lorsqu'un utilisateur vient de s'authentifier auprès d'un service,
           les bonnes pratiques recommandent de renouveler son identifiant
           de session pour éviter les attaques par fixation de session.
           C'est ce que fait ici ``session_regenerate_id``. Cependant,
           pour permettre au SLO de fonctionner, vous devez notifier la
           bibliothèque Arise que cet identifiant a changé,
           c'est ce que permet ``$consumer-&gt;session_id_changed``.
        */</span>

        <span class="name builtin">session_regenerate_id</span><span class="punctuation">();</span>
        <span class="comment multiline">/*
           Il est plus propre et efficace de faire cet appel regroupé
           avec tous les autres (donc entre un $consumer-&gt;api()-&gt;begin()
           et un done() mais pour l'exemple c'est plus lisible.
        */</span>
        <span class="name variable">$consumer</span><span class="operator">-&gt;</span><span class="name attribute">session_id_changed</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="keyword">if</span> <span class="punctuation">(</span><span class="name variable">$consumer</span><span class="operator">-&gt;</span><span class="name attribute">is_authenticated</span><span class="punctuation">())</span> <span class="punctuation">{</span>
        <span class="comment multiline">/*
           Ici l'utilisateur est authentifié, c'est à dire qu'il s'est
           connecté à AriseID et nous a autorisé à accéder à ses
           informations privées.
           Attention les autorisations facultatives n'ont pas forcément
           été données. Il existe deux méthodes pour le savoir :
            * tenter l'appel et vérifier l'erreur renvoyée ou,
            * faire d'abord un appel à ``$consumer-&gt;api()-&gt;get_authorizations()``
                        qui renverra un tableau avec toutes les
                        autorisations que l'utilisateur a données.
        */</span>

        <span class="comment multiline">/*
           Il existe deux moyens de faire des appels à l'API Arise :
            * $resultat = $consumer-&gt;api()
                -&gt;mon_appel($argument1, $argument2) :
                        cet appel va envoyer une requête immédiatement à
                        Arise pour exécuter l'appel et le retour de la
                        fonction sera la valeur de retour renvoyée par Arise.
                        Une exception sera générée en cas d'erreur.
            * $results = $consumer-&gt;api()-&gt;begin()
                -&gt;mon_appel1($argument1, $argument2)
                -&gt;mon_appel2()-&gt;done() :
                        cet appel permet d'envoyer simultanément
                        plusieurs requêtes à Arise. Cette méthode
                        doit être préférée car plus efficace.
           Cet ensemble d'appels renvoie un tableau de fonctions permettant d'obtenir les
           résultats. Nous allons voir ci-dessous comment accéder à chaque résultat.
        */</span>
        <span class="name variable">$results</span> <span class="operator">=</span> <span class="name variable">$consumer</span><span class="operator">-&gt;</span><span class="name attribute">api</span><span class="punctuation">()</span><span class="operator">-&gt;</span><span class="name attribute">begin</span><span class="punctuation">()</span>
                <span class="operator">-&gt;</span><span class="name attribute">get_identifiant</span><span class="punctuation">()</span>
                <span class="operator">-&gt;</span><span class="name attribute">get_prenom</span><span class="punctuation">()</span>
                <span class="operator">-&gt;</span><span class="name attribute">get_statut_aeiie</span><span class="punctuation">()</span>
                <span class="operator">-&gt;</span><span class="name attribute">done</span><span class="punctuation">();</span>

        <span class="comment multiline">/*
           Nous accédons au résultat en faisant un appel : ``$result[0]``
           correspond à un résultat et nous l'appelons : ``$result[0]()``.
           Cet appel générera une exception si Arise a renvoyé une erreur
           lors de l'appel. Sinon, la valeur de retour est le résultat
           de l'appel que nous affichons ici.
        */</span>
        <span class="keyword">try</span> <span class="punctuation">{</span>
                <span class="name variable">$ident</span> <span class="operator">=</span> <span class="name variable">$results</span><span class="punctuation">[</span><span class="literal number integer">0</span><span class="punctuation">]();</span>
                <span class="keyword">echo</span> <span class="literal string double">&quot;Bonjour &quot;</span><span class="operator">.</span><span class="name variable">$ident</span><span class="operator">.</span><span class="literal string double">&quot; !&quot;</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>
        <span class="keyword">catch</span><span class="punctuation">(</span><span class="name other">OAuthAPIException</span> <span class="name variable">$e</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                <span class="keyword">echo</span> <span class="literal string double">&quot;Erreur : &quot;</span><span class="operator">.</span><span class="name variable">$e</span><span class="operator">-&gt;</span><span class="name attribute">getMessage</span><span class="punctuation">();</span>
        <span class="punctuation">}</span>

        <span class="comment multiline">/*
           Nous faisons de même avec les autres résultats.
           Ils sont dans le même ordre que les appels ci-dessus.
        */</span>
        <span class="keyword">try</span> <span class="punctuation">{</span>
                <span class="name variable">$prenom</span> <span class="operator">=</span> <span class="name variable">$results</span><span class="punctuation">[</span><span class="literal number integer">1</span><span class="punctuation">]();</span>
                <span class="keyword">echo</span> <span class="literal string double">&quot;Kikoooo &quot;</span><span class="operator">.</span><span class="name variable">$prenom</span><span class="operator">.</span><span class="literal string double">&quot; !!!&quot;</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>
        <span class="keyword">catch</span><span class="punctuation">(</span><span class="name other">OAuthAPIException</span> <span class="name variable">$e</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                <span class="keyword">echo</span> <span class="literal string double">&quot;Erreur : &quot;</span><span class="operator">.</span><span class="name variable">$e</span><span class="operator">-&gt;</span><span class="name attribute">getMessage</span><span class="punctuation">();</span>
        <span class="punctuation">}</span>

        <span class="keyword">try</span> <span class="punctuation">{</span>
                <span class="name variable">$bde</span> <span class="operator">=</span> <span class="name variable">$results</span><span class="punctuation">[</span><span class="literal number integer">2</span><span class="punctuation">]();</span>
                <span class="keyword">echo</span> <span class="literal string double">&quot;Tu es un adhérent AEIIE : &quot;</span><span class="operator">.</span>
                        <span class="punctuation">(</span><span class="name variable">$bde</span> <span class="operator">?</span> <span class="literal string double">&quot;oui&quot;</span> <span class="operator">:</span> <span class="literal string double">&quot;non&quot;</span><span class="punctuation">)</span><span class="operator">.</span><span class="literal string double">&quot; !!!&quot;</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>
        <span class="keyword">catch</span><span class="punctuation">(</span><span class="name other">OAuthAPIException</span> <span class="name variable">$e</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                <span class="keyword">echo</span> <span class="literal string double">&quot;Erreur : &quot;</span><span class="operator">.</span><span class="name variable">$e</span><span class="operator">-&gt;</span><span class="name attribute">getMessage</span><span class="punctuation">();</span>
        <span class="punctuation">}</span>

<span class="comment multiline">/*
   Ici nous affichons les moyens de se déconnecter. Avec AriseID il est
   possible de se déconnecter simultanément de toutes les applications
   en même temps. C'est le Single Logout (SLO).
   Une application bien développée devrait permettre à ses utilisateurs
   de le faire.

   L'appel à ``$consumer-&gt;get_single_logout_uri($callback)`` renvoie
   l'URL vers laquelle rediriger l'utilsateur lorsqu'il veut se
   déconnecter.
   L'argument de la fonction est l'URL vers laquelle l'utilisateur sera
   redirigé ensuite : votre page principale par exemple.
*/</span>
<span class="comment preproc">?&gt;</span><span class="other">
    &lt;form method=&quot;post&quot;&gt;
    &lt;input type=&quot;submit&quot; name=&quot;logout&quot; value=&quot;D&amp;eacute;connexion&quot;/&gt;
    &lt;/form&gt;
    &lt;a href=&quot;</span><span class="comment preproc">&lt;?php</span> <span class="keyword">echo</span> <span class="name variable">$consumer</span><span class="operator">-&gt;</span><span class="name attribute">get_single_logout_uri</span><span class="punctuation">(</span>
        <span class="name other">OAuthAriseClient</span><span class="operator">::</span><span class="name attribute">getScriptURL</span><span class="punctuation">())</span> <span class="comment preproc">?&gt;</span><span class="other">&quot;&gt;
        D&amp;eacute;connexion de AriseID
    &lt;/a&gt;
</span><span class="comment preproc">&lt;?php</span>

<span class="punctuation">}</span>
<span class="keyword">else</span> <span class="punctuation">{</span>
<span class="comment multiline">/*
   Ici, nous ne sommes pas authentifiés. Nous affichons donc un bouton
   pour initier la connexion.
*/</span>
<span class="comment preproc">?&gt;</span><span class="other">
        &lt;form method='POST'&gt;
                &lt;input type='submit' value='Log In with AriseID'
                        name='login' /&gt;
        &lt;/form&gt;
</span><span class="comment preproc">&lt;?php</span>
<span class="punctuation">}</span>
<span class="comment preproc">?&gt;</span>
</pre>
</div>
<div class="section" id="fonctions-de-la-bibliotheque-ariseid">
<h1>Fonctions de la bibliothèque AriseID</h1>
<div class="section" id="oauthariseclient">
<h2><tt class="docutils literal">OAuthAriseClient</tt></h2>
<div class="section" id="static-public-function-getinstance-consumer-key-consumer-secret-consumer-private-key">
<h3><tt class="docutils literal">static public function <span class="pre">getInstance($consumer_key,</span> $consumer_secret, $consumer_private_key)</tt></h3>
<p>Renvoie une nouvelle instance de client permettant de faire l'authentifcation et les appels à l'API.</p>
<p>Cette fonction prend les arguments suivants :</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal">consumer_key</tt>: l'identifiant du client donné par AriseID</li>
<li><tt class="docutils literal">consumer_secret</tt>: le secret du client donné par AriseID</li>
<li><tt class="docutils literal">consumer_private_key</tt>: une clé privée au consommateur, sert à chiffrer l'identifiant de session lors de son stockage sur le serveur</li>
</ul>
</blockquote>
</div>
<div class="section" id="public-function-set-callback-callback">
<h3><tt class="docutils literal">public function <span class="pre">set_callback($callback)</span></tt></h3>
<p>Définit l'URL de retour une fois que l'utilisateur s'est authentifié auprès de AriseID et accepté les autorisations.
Par défaut, l'URL de retour est l'URL de la page lors de l'appel à <tt class="docutils literal">authenticate</tt>.</p>
<p>Cette fonction prend l'argument suivant :</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal">callback</tt>: l'URL de retour</li>
</ul>
</blockquote>
</div>
<div class="section" id="public-function-authenticate">
<h3><tt class="docutils literal">public function authenticate()</tt></h3>
<p>Démarre la procédure d'authentification. Obtient un jeton temporaire et redirige l'utilisateur vers la page d'authentification AriseID. Ne retourne pas mais peut générer des exceptions.
Cette fonction est utilisée par les clients de type Web.</p>
<p>Cette fonction ne prend pas d'arguments.</p>
</div>
<div class="section" id="public-function-get-authorize-uri">
<h3><tt class="docutils literal">public function get_authorize_uri()</tt></h3>
<p>Démarre la procédure d'authentification. Obtient un jeton temporaire et renvoie l'URL vers laquelle l'utilisateur doit se diriger.
Cette fonction est utilisée par les clients de type bureau/OOB.</p>
<p>Cette fonction ne prend pas d'arguments.</p>
</div>
<div class="section" id="public-function-got-oob-verifier-verifier">
<h3><tt class="docutils literal">public function <span class="pre">got_oob_verifier($verifier)</span></tt></h3>
<p>Indique à la librairie que le code de vérification affiché à l'utilisateur par le serveur OAuth a été renseigné chez le client.
Cette fonction est utilisée par les clients de type bureau/OOB.</p>
<p>Cette fonction prend l'argument suivant :</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal">verifier</tt>: le code de vérification que l'utilisateur a saisi</li>
</ul>
</blockquote>
</div>
<div class="section" id="public-function-has-just-authenticated">
<h3><tt class="docutils literal">public function has_just_authenticated()</tt></h3>
<p>Renvoie un booleen déterminant si la procédure d'authenfication vient de se terminer dans la requête courante.</p>
<p>Cette fonction ne prend pas d'arguments.</p>
</div>
<div class="section" id="public-function-is-authenticated">
<h3><tt class="docutils literal">public function is_authenticated()</tt></h3>
<p>Renvoie un booleen déterminant si l'utilisateur est authentifié.</p>
<p>Cette fonction ne prend pas d'arguments.</p>
</div>
<div class="section" id="public-function-api">
<h3><tt class="docutils literal">public function api()</tt></h3>
<p>Renvoie une instance de OAuthAPICaller qui permettra d'effectuer des requêtes à l'API AriseID.</p>
<p>Cette fonction ne prend pas d'arguments.</p>
</div>
<div class="section" id="public-function-logout">
<h3><tt class="docutils literal">public function logout()</tt></h3>
<p>Efface les jetons stockés en variable de session et réinitialise le client. L'utilisateur n'est plus authentifié après cet appel.</p>
<p>Cette fonction ne prend pas d'arguments.</p>
</div>
<div class="section" id="public-function-session-id-changed">
<h3><tt class="docutils literal">public function session_id_changed()</tt></h3>
<p>Indique à la bibiliothèque que l'identifiant de session a changé. La fonction appelle AriseID pour mettre à jour l'information. Cette fonction est nécessaire pour permettre au Single LogOut de bien fonctionner.</p>
<p>Cette fonction ne prend pas d'arguments.</p>
</div>
<div class="section" id="static-public-function-get-single-logout-uri-return-uri">
<h3><tt class="docutils literal">static public function <span class="pre">get_single_logout_uri($return_uri)</span></tt></h3>
<p>Renvoie l'URL où envoyer l'utilisateur pour qu'il puisse se déconnecter d'un seul coup de tous les sites clients AriseID (Single LogOut de session). L'utilisateur sera ensuite redirigé vers l'URL renseignée si il n'y a pas eu d'erreur de déconnexion. Dans le cas contraire, l'utilisateur sera informé de l'échec et invité à revenir vers l'URL.</p>
<p>Cette fonction prend l'argument suivant :</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal">return_uri</tt>: l'URL de retour vers où rediriger l'utilisateur</li>
</ul>
</blockquote>
</div>
<div class="section" id="static-public-function-getscripturl-with-query-true">
<h3><tt class="docutils literal">static public function <span class="pre">getScriptURL($with_query</span> = TRUE)</tt></h3>
<p>Renvoie l'URL de la page actuelle. Optionnellement avec les paramètres passés en query (après le ?).</p>
<p>Cette fonction prend l'argument suivant :</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal">with_query</tt>: TRUE pour inclure la partie query dans l'URL renvoyée</li>
</ul>
</blockquote>
</div>
<div class="section" id="public-function-set-cleanup-callback-cleanup">
<h3><tt class="docutils literal">public function <span class="pre">set_cleanup_callback($cleanup)</span></tt></h3>
<p>Indique à la bibilothèque si elle doit nettoyer l'URL une fois l'authentification réalisée pour supprimer les paramètres liés à OAuth.
Par défaut le nettoyage est effectué et une redirection supplémentaire est effectuée.</p>
<p>Cette fonction prend l'argument suivant :</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal">$cleanup</tt>: booleen indiquant si il faut effectuer le nettoyage</li>
</ul>
</blockquote>
</div>
</div>
<div class="section" id="oauthapicaller">
<h2><tt class="docutils literal">OAuthAPICaller</tt></h2>
<div class="section" id="public-function-begin">
<h3><tt class="docutils literal">public function begin()</tt></h3>
<p>Active l'appel à l'API par lot. Une fois cet appel effectué, les divers appels de fonction seront mis en cache et la fonction <tt class="docutils literal">done</tt> effectuera l'ensemble des appels en une seule requête.
Cette fonction renvoie l'instance d'<tt class="docutils literal">OAuthAPICaller</tt> utilisée pour l'appel.</p>
<p>Cette fonction ne prend pas d'arguments.</p>
</div>
<div class="section" id="public-function-done">
<h3><tt class="docutils literal">public function done()</tt></h3>
<p>Termine une série d'appels par lot. Cette fonction renvoie un tableau contenant des foncteurs.
Chaque foncteur renverra le résultat de l'appel à l'API lorsqu'il sera appelé ou générera une exception en cas d'erreur de l'API.</p>
<p>Cette fonction ne prend pas d'arguments.</p>
</div>
<div class="section" id="public-function-fonction-api">
<h3><tt class="docutils literal">public function &lt;fonction <span class="pre">API&gt;(...)</span></tt></h3>
<p>Fonction générique qui permet de réaliser un appel à l'API.</p>
<p>Entre un appel à <tt class="docutils literal">begin</tt> et un appel à <tt class="docutils literal">done</tt>, cette fonction met en cache l'appel et retourne l'instance d'<tt class="docutils literal">OAuthAPICaller</tt> utilisée pour l'appel.
En dehors de ces appels, cette fonction effectue l'appel et renvoie le résultat ou une exception en cas d'erreur.</p>
<p>Cette fonction prend le nombre d'arguments attendu par l'API.</p>
</div>
</div>
</div>
<div class="section" id="oauth-pour-les-nuls">
<h1>OAuth pour les nuls</h1>
<div class="section" id="le-standard-oauth-1-0a">
<h2>Le standard OAuth 1.0a</h2>
<p>OAuth (<a class="reference external" href="https://tools.ietf.org/html/rfc5849">RFC 5849</a>) fournit une méthode à des clients leur permettant d'accéder à des ressources stockées sur un serveur au nom du possesseur de la ressource (un autre client ou un utilisateur final). Il fournit aussi un moyen pour les utilisateurs finaux d'autoriser un tiers à accéder à leurs ressources stockées sur le serveur sans avoir à partager leurs identifiants de connexion (par exemple, un identifiant et un mot de passe), en utilisant des redirections côté navigateur.</p>
<p>De cette description librement traduite de la RFC, nous allons essayer d'expliquer qui fait quoi.</p>
<p>OAuth mentionne trois entités :</p>
<blockquote>
<ul class="simple">
<li>un possesseur de ressource (<em>resource owner</em>, <em>end-user</em> ou <em>user</em>) : il s'agit des élèves qui visiteront votre application,</li>
<li>un serveur (<em>server</em> ou <em>provider</em>) qui possède des données et auxquelles votre application veut accéder : dans notre cas, il s'agit de AriseID,</li>
<li>un client (<em>consumer</em>) : votre application qui voudra accéder aux données des élèves.</li>
</ul>
</blockquote>
<p>Le principe de OAuth est de permettre à une application d'accéder aux données d'un élève sans que celui-ci n'ait à fournir son couple identifiant/mot de passe à l'application. AriseID étant responsable de l'authentification et s'assurant de l'accord de l'utilisateur avant de transmettre les informations demandées à l'application.</p>
<p>Une application OAuth, pour accéder aux données de l'utilisateur, a préalablement besoin d'un couple identifiant/secret partagé qui lui sera donné par AriseID. C'est dans le chapitre <a class="reference internal" href="#preparation">Préparation</a> qu'est expliqué comment obtenir ces informations.</p>
<p>Le processus d'authentification de l'utilisateur se déroule comme ceci :</p>
<blockquote>
<ul class="simple">
<li>l'élève se rend sur la page de l'application (par exemple <tt class="docutils literal"><span class="pre">http://toto.iiens.net/monapplication/</span></tt>),</li>
<li>il initie une authentification en demandant à se connecter (par exemple en cliquant un bouton <em>Se connecter à AriseID</em>),</li>
<li>l'application demande à AriseID un jeton temporaire en spécifiant une URL de retour (cette tâche est effectuée par la bibilothèque OAuth et vous n'avez pas besoin de vous en préoccuper),</li>
<li>l'application redirige ensuite l'utilisateur vers <tt class="docutils literal"><span class="pre">http://oauth.iiens.net/authorize.php?token=&lt;identifiant</span> du token&gt;</tt>,</li>
<li>l'élève est invité à s'authentifier si il ne l'est pas déjà et à autoriser l'application à accéder à ses données,</li>
<li>une fois que l'élève a accepté, AriseID redirige l'élève vers l'URL renseignée dans la demande de jeton temporaire,</li>
<li>l'application utilise son jeton temporaire pour le convertir en un jeton longue durée qui lui permettra d'accéder à l'API de AriseID,</li>
<li>l'application effectue ses appels à l'API AriseID pour accéder aux ressources de l'utilisateur.</li>
</ul>
</blockquote>
<p>OAuth décrit les mécanismes généraux pour effectuer une authentification. Certains paramètres sont laissés au choix de l'administrateur du serveur. Charge à lui de les communiquer aux dévelopeurs des clients.
AriseID est configuré avec les paramètres suivants :</p>
<blockquote>
<ul class="simple">
<li>Temporary Credential Request : <tt class="docutils literal"><span class="pre">https://oauth.iiens.net/initiate.php</span></tt></li>
<li>Resource Owner Authorization URI : <tt class="docutils literal"><span class="pre">https://oauth.iiens.net/authorize.php</span></tt></li>
<li>Token Request URI : <tt class="docutils literal"><span class="pre">https://oauth.iiens.net/token.php</span></tt></li>
<li>Signature Method : <tt class="docutils literal"><span class="pre">HMAC-SHA1</span></tt></li>
</ul>
</blockquote>
</div>
<div class="section" id="les-specificites-ajoutees-par-arise">
<h2>Les spécificités ajoutées par Arise</h2>
<div class="section" id="api">
<h3>API</h3>
<p>Le protocole OAuth laisse aux serveurs le soin de décider comment accéder aux données une fois l'authentification réalisée.
Pour AriseID, l'accès se fait via <tt class="docutils literal"><span class="pre">http://oauth.iiens.net/api.php</span></tt>. Il s'agit d'une requête :</p>
<blockquote>
<ul class="simple">
<li>avec la méthode <tt class="docutils literal">POST</tt>,</li>
<li>un header <tt class="docutils literal"><span class="pre">Content-Type:</span> application/json</tt>,</li>
<li>son corps contient un ou plusieurs appels <a class="reference external" href="http://www.jsonrpc.org/specification">JSON-RPC 2</a>,</li>
<li>les paramètres OAuth sont complétés par un paramètre <tt class="docutils literal">oauth_api_call_hash</tt> contenant un hash SHA-256 du corps de la requête,</li>
<li>et authentifiée comme indiqué dans la RFC (le corps de la requête ne fait donc pas partie de la signature).</li>
</ul>
</blockquote>
<p>Les méthodes fournies par AriseID sont :</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal">get_authorizations()</tt> : renvoie un tableau avec toutes les autorisations accordées par l'utilisateur,</li>
<li><tt class="docutils literal"><span class="pre">set_consumer_data($data)</span></tt> : sauvegarde une donnée fournie par le client pour utilisation ultérieure, cette donnée est associée au jeton et communiquée lors du Single LogOut,</li>
<li><tt class="docutils literal">get_consumer_data()</tt> : renvoie la donnée précédemment fournie par le client.</li>
</ul>
</blockquote>
<p>Elles sont disponibles pour tous les clients sans aucune autorisation nécessaire.</p>
<p>Les méthodes suivantes sont également fournies, sous réserve de demander l'autorisation :</p>
<blockquote>
<ul class="simple">
<li><tt class="docutils literal">get_identifiant()</tt> : Lire l'identifiant</li>
<li><tt class="docutils literal">get_nom()</tt> : Lire le nom de famille</li>
<li><tt class="docutils literal">get_prenom()</tt> : Lire le prénom</li>
<li><tt class="docutils literal">get_nom_complet()</tt> : Lire le nom complet</li>
<li><tt class="docutils literal">get_surnom()</tt> : Lire le surnom</li>
<li><tt class="docutils literal">get_sexe()</tt> : Lire le sexe (renvoie M ou F)</li>
<li><tt class="docutils literal">get_promotion()</tt> : Lire la promotion</li>
<li><tt class="docutils literal">get_naissance_date()</tt> : Lire la date de naissance</li>
<li><tt class="docutils literal">get_email()</tt> : Lire l'e-mail préféré (l'e-mail personnel si il est renseigné, l'e-mail ENSIIE sinon)</li>
<li><tt class="docutils literal">get_email_ensiie()</tt> : Lire l'e-mail ENSIIE</li>
<li><tt class="docutils literal">get_email_perso()</tt> : Lire l'e-mail personnel</li>
<li><tt class="docutils literal">get_localisation()</tt> : Lire la localisation (Evry = 0/Strasbourg = 1)</li>
<li><tt class="docutils literal">get_groupe()</tt> : Lire le groupe</li>
<li><tt class="docutils literal">get_statut_ecole()</tt> : Lire le statut à l'école (FI = 0/FIPA = 1)</li>
<li><tt class="docutils literal">get_statut_arise()</tt> : Lire le statut ARISE (1 si l'élève est adhérent Arise, 0 sinon)</li>
<li><tt class="docutils literal">get_statut_aeiie()</tt> : Lire le statut AEIIE (1 si l'élève est adhérent AEIIE, 0 sinon)</li>
<li><tt class="docutils literal">get_statut_compte()</tt> : Lire le statut du compte (TRUE si le compte est actif, FALSE sinon)</li>
<li><tt class="docutils literal">get_assoce_member()</tt> : Lire les associations dont l'utilisateur est membre</li>
<li><tt class="docutils literal">get_assoce_master()</tt> : Lire les associations dont l'utilisateur est administateur</li>
<li><tt class="docutils literal">get_assoce_owner()</tt> : Lire les associations dont l'utilisateur est président</li>
<li><tt class="docutils literal">get_logement_adresse()</tt> : Lire l'adresse postale</li>
<li><tt class="docutils literal">get_logement_appart()</tt> : Lire le numéro d'appartement</li>
<li><tt class="docutils literal">get_telephone_maison()</tt> : Lire le numéro de téléphone fixe</li>
<li><tt class="docutils literal">get_telephone_portable()</tt> : Lire le numéro de téléphone portable</li>
<li><tt class="docutils literal">get_site_web()</tt> : Lire l'adresse du site Web</li>
<li><tt class="docutils literal">get_im_icq()</tt> : Lire le n° ICQ</li>
<li><tt class="docutils literal">get_im_jabber()</tt> : Lire l'adresse Jabber</li>
<li><tt class="docutils literal">get_cv_de()</tt> : Lire l'URL du CV en allemand</li>
<li><tt class="docutils literal">get_cv_en()</tt> : Lire l'URL du CV en anglais</li>
<li><tt class="docutils literal">get_cv_fr()</tt> : Lire l'URL du CV en français</li>
<li><tt class="docutils literal">get_cv_file()</tt> : Lire l'URL du CV (fichier)</li>
<li><tt class="docutils literal">get_cv_it()</tt> : Lire l'URL du CV en italien</li>
<li><tt class="docutils literal">get_cv_sp()</tt> : Lire l'URL du CV en espagnol</li>
</ul>
</blockquote>
</div>
<div class="section" id="single-logout">
<h3>Single LogOut</h3>
<p>OAuth ne fournit aucune fonctionnalité de déconnexion. Pour AriseID, une fonctionnalité a été introduite. Lors de la création d'une application, une URL de déconnexion est renseignée par le développeur.
Lorsque l'utilisateur se déconnecte de l'ensemble des sites, AriseID va contacter l'ensemble des URLs de déconnexion en leur communiquant dans l'en-tête HTTP <tt class="docutils literal">OAuthLogout</tt> le token invalidé et la donnée cliente associée.</p>
<p>LA bibliothèque OAuth Arise gère automatiquement le Single LogOut. Le seul pré-requis étant que <tt class="docutils literal"><span class="pre">OAuthAriseClient::getInstance</span></tt> soit appelé dans le code exécuté lors de la requête de logout.</p>
</div>
</div>
</div>
</div>
</body>
</html>
